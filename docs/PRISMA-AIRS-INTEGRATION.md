# Prisma AIRS AI Runtime Security Integration

This document describes how the MCP Gateway integrates Palo Alto Networks' Prisma AIRS comprehensive AI Runtime Security capabilities to protect against AI/LLM security threats throughout the request/response pipeline.

## Prisma AIRS Capabilities Overview

Prisma AIRS provides multi-layered AI security across four protection domains:

### 1. **AI Model Protection**
- **Prompt Injection Detection**: Identifies attempts to manipulate LLM behavior through crafted prompts (attacks that try to override model instructions)
- **Contextual Grounding**: Prevents hallucinations by detecting when LLM responses contain information not in the provided context or contradicts it
  - Addresses AI model responses containing factual information not present in or contradicting the provided context
  - Only available for response analysis (requires context parameter)

### 2. **AI Data Protection** 
- **Sensitive Data Detection (DLP)**: Identifies sensitive patterns including:
  - Payment cards (Visa, MC, AMEX, Discover)
  - Social Security Numbers (SSN)
  - Bank account numbers
  - API keys and tokens
  - Passwords and secrets
  - Email addresses
  - Database connection strings
- **Data Masking**: Replaces detected sensitive patterns with `XXXXXXX` (X count matches original length) to prevent data exposure

### 3. **AI Application Protection**
- **Malicious Code Detection**: Analyzes code snippets generated by LLMs for security vulnerabilities
  - Supported languages: JavaScript, Python, VBScript, PowerShell, Batch, Shell, Perl
  - Provides SHA-256, file type, known verdict, code action, and malware analysis
- **Malicious URL Detection**: 
  - Basic: Detects predefined malicious URL categories (phishing, malware, botnet, etc.)
  - Advanced: Override default action for specific URL categories

### 4. **AI Agent Protection**
- **Function Schema Leakage Detection**: Prevents unauthorized exposure of MCP tool/function definitions and parameters
- **Direct Tool Invocation Detection**: Detects attempts to invoke tools directly through prompt manipulation
- **Memory Manipulation Detection**: Identifies attempts to manipulate agent memory, context, or session state
- **Pattern-based & Model-based Protection**: Works with or without configured AI Agent frameworks

## Prisma AIRS API Response Structure

When Prisma AIRS analyzes content, it returns:

```javascript
{
  action: "allow" | "block",      // Based on security profile policy
  category: "malicious" | "benign",
  report_id: "string",            // Unique report identifier
  scan_id: "uuid",                // Unique scan identifier
  profile_id: "uuid",             // Security profile ID used
  profile_name: "string",         // Security profile name
  created_at: "ISO8601",          // Scan request timestamp
  completed_at: "ISO8601",        // Scan completion timestamp
  
  // Detection flags for prompts
  prompt_detected: {
    injection: boolean,           // Prompt injection attempt detected?
    toxic_content: boolean,       // Toxic/abusive language detected?
    malicious_code: boolean,      // Malicious code in prompt?
    dlp: boolean,                 // Sensitive data patterns detected?
    url_cats: boolean,            // Malicious URLs detected?
    agent: boolean,               // Agent threats detected?
    topic_violation: boolean      // Custom topic guardrail violation?
  },
  
  // Detection flags for responses
  response_detected: {
    ungrounded: boolean,          // Response contains hallucinations?
    db_security: boolean,         // Database security issues?
    malicious_code: boolean,      // Malicious code in response?
    dlp: boolean,                 // Sensitive data in response?
    url_cats: boolean             // Malicious URLs in response?
  },
  
  // Masked versions of content (only when masking enabled)
  prompt_masked_data: {
    data: "string with XXXXXXX replacements",
    pattern_detections: [
      { pattern: "SSN", count: 1 },
      { pattern: "CREDIT_CARD", count: 2 },
      { pattern: "API_KEY", count: 1 }
    ]
  },
  
  response_masked_data: {
    data: "string with XXXXXXX replacements",
    pattern_detections: [...]
  }
}
```

## MCP Gateway Integration Points

The coordinator implements Prisma AIRS scanning at **4 strategic security checkpoints**:

### Checkpoint 1: Initial User Input
**Method**: `analyzeUserInput()` â†’ `coordinator.js`

Scans raw user input for ALL threat types before processing:

```javascript
const result = await this.prismaAIRS.analyzePrompt(userQuery, {
  language: 'en',
  appName: 'mcp-gateway',
  appUser: 'user',
  aiModel: 'qwen3:1.7b',
  trId: `user-input-${Date.now()}`
});

// Threat response
if (result.action === "block") {
  // Block and return security error message
  return { error: "Security policy violation detected" };
}

// Data protection - use masked if sensitive data found
if (result.prompt_detected.dlp) {
  queryToProcess = result.prompt_masked_data.data;  // Use masked version
  console.log(`ğŸ”’ DLP Detection:`, result.prompt_masked_data.pattern_detections);
}

// Threat detection
if (result.prompt_detected.injection) {
  console.log(`âš ï¸ Prompt injection attempt detected`);
}
```

**Detections Performed**:
- âœ… Prompt injection attacks
- âœ… Toxic/abusive language
- âœ… Malicious code in prompt
- âœ… Sensitive data (DLP)
- âœ… Malicious URLs
- âœ… Agent threats

**Action**: Sets `queryToProcess` to masked version if sensitive data detected, ensuring downstream operations use protected content.

---

### Checkpoint 2: Outbound to MCP Agent
**Method**: `analyzeOutboundRequest()` â†’ `coordinator.js`

Verifies request is policy-compliant before sending to agent:

```javascript
const outboundResult = await this.prismaAIRS.analyzePrompt(queryToProcess, {
  language: 'en',
  appName: 'mcp-gateway',
  appUser: agentName,
  aiModel: this.coordinatorModel,
  trId: `outbound-${agentName}-${Date.now()}`
});

if (outboundResult.action === "block") {
  // Block: even masked version violates policy
  throw new Error(`Security blocked outbound request to ${agentName}`);
}

// Send to agent (will be masked query if DLP detected in CP1)
const agentResponse = await this.queryAgent(agentId, queryToProcess);
```

**Purpose**: 
- Ensures even masked content complies with policies
- Prevents policy violations from reaching agents
- Logs attempt details for audit trail

---

### Checkpoint 3: Inbound from Agent
**Method**: `analyzeInboundResponse()` â†’ `coordinator.js`

Scans agent responses for threats before returning to user:

```javascript
const responseResult = await this.prismaAIRS.analyzePromptAndResponse(
  queryToProcess,           // Original (possibly masked) query
  agentResponse,            // Agent's response
  {
    language: 'en',
    appName: 'mcp-gateway',
    appUser: agentName,
    trId: `inbound-${agentName}-${Date.now()}`
  }
);

// Threat handling
if (responseResult.action === "block") {
  return { error: "Response blocked by security policy" };
}

// Data protection - mask if agent leaked sensitive data
if (responseResult.response_detected.dlp) {
  responseToReturn = responseResult.response_masked_data.data;
  console.log(`ğŸ”’ Agent response contains sensitive data - masked`);
}

// Hallucination detection
if (responseResult.response_detected.ungrounded) {
  console.log(`âš ï¸ Hallucination detected in response`);
}

// Code security
if (responseResult.response_detected.malicious_code) {
  console.log(`ğŸš« Malicious code detected in response`);
}
```

**Detections Performed**:
- âœ… Ungrounded responses (hallucinations)
- âœ… Database security issues
- âœ… Malicious code in response
- âœ… Sensitive data leakage
- âœ… Malicious URLs in response

**Action**: Masks agent response if sensitive data detected, preventing data leakage to users.

---

### Checkpoint 4: Final Synthesized Response
**Method**: `analyzeFinalResponse()` â†’ `coordinator.js`

Final security check before returning multi-agent synthesized response:

```javascript
const finalResult = await this.prismaAIRS.analyzePromptAndResponse(
  queryToProcess,
  synthesizedResponse,
  {
    language: 'en',
    appName: 'mcp-gateway',
    appUser: 'final-output',
    trId: `final-output-${Date.now()}`
  }
);

// Final threat check
if (finalResult.action === "block") {
  return { error: "Final response blocked by security policy" };
}

// Final data protection
if (finalResult.response_detected.dlp) {
  finalResponse = finalResult.response_masked_data.data;
}
```

**Purpose**: 
- Multi-agent synthesis might reintroduce sensitive data patterns
- Final masking pass ensures all data is protected
- Catches threats introduced during response combination

## Data Flow Through Checkpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Input: "Name: John, SSN: 489-36-8350, CC: 4929-3813-3266-4295" â”‚
â”‚ Threats: [DLP - SSN, DLP - CREDIT_CARD]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â–º CP1: Initial Analysis (analyzeUserInput)
              â”‚    â”œâ”€ Detect: prompt_detected.dlp = true
              â”‚    â”œâ”€ Detect: prompt_detected.injection = false
              â”‚    â”œâ”€ Extract masked: "Name: John, SSN: XXXXXXX, CC: XXXXXXX"
              â”‚    â””â”€ Set: queryToProcess = masked version
              â”‚
              â”œâ”€â”€â–º Translation (on masked query)
              â”‚    â””â”€ Input: Masked query â†’ Output: Translated masked
              â”‚
              â”œâ”€â”€â–º Routing Decision (on masked query)
              â”‚    â””â”€ Determine agent using masked query
              â”‚
              â”œâ”€â”€â–º CP2: Outbound Verification (analyzeOutboundRequest)
              â”‚    â”œâ”€ Verify masked query passes policy
              â”‚    â”œâ”€ Check: action = "allow"
              â”‚    â””â”€ Send masked query to agent
              â”‚
              â”œâ”€â”€â–º MCP Agent Processes
              â”‚    â”œâ”€ Input: Masked query
              â”‚    â””â”€ Output: Agent response (might contain new data)
              â”‚
              â”œâ”€â”€â–º CP3: Response Analysis (analyzeInboundResponse)
              â”‚    â”œâ”€ Check: response_detected for threats
              â”‚    â”œâ”€ Detect: response_detected.dlp = true
              â”‚    â”œâ”€ Detect: response_detected.ungrounded = true
              â”‚    â”œâ”€ Extract masked response
              â”‚    â””â”€ Use masked for synthesis
              â”‚
              â”œâ”€â”€â–º Multi-Agent Synthesis (if needed)
              â”‚    â””â”€ Combine responses (masked versions)
              â”‚
              â”œâ”€â”€â–º CP4: Final Check (analyzeFinalResponse)
              â”‚    â”œâ”€ Analyze: synthesized response
              â”‚    â”œâ”€ Extract: masked version if DLP detected
              â”‚    â””â”€ Final masking pass
              â”‚
              â””â”€â”€â–º Return to User: Masked response only
                   "Name: John, SSN: XXXXXXX, CC: XXXXXXX ..."
```

## Security Profile Configuration

Prisma AIRS uses **Security Profiles** to define detection and response behavior:

### Profile Configuration Options

| Protection Domain | Settings | Actions |
|---|---|---|
| **AI Model** | Prompt Injection Detection | Allow / Block |
| | Contextual Grounding | Allow / Block |
| **AI Data** | Sensitive Data Detection (DLP) | Allow / Block |
| | Masking Enabled | Yes / No (requires Block) |
| **AI Application** | Malicious Code Detection | Allow / Block |
| | Malicious URL Detection (Basic) | Allow / Block |
| | Malicious URL Detection (Advanced) | Custom per URL category |
| **AI Agent** | Agent Protection | Allow / Block |
| **Latency** | Response Time Threshold | Allow / Block when exceeded |

### Masking Availability

- **Enabled when**: DLP detection set to "Block" action
- **Only applies to**: Response masking (API output)
- **Default behavior**: Sensitive data replaced with `XXXXXXX` (length-preserving)

## Implementation in MCP Gateway

### Activation

Prisma AIRS security is activated with `phase: "phase3"`:

```javascript
// Enables all 4 security checkpoints
const result = await coordinator.processQuery(
  userQuery,
  language,
  'phase3',     // Activates Prisma AIRS scanning
  userContext
);
```

### Checkpoint Methods

All checkpoint methods follow the same pattern:

```javascript
async analyzeXxx(content, metadata) {
  if (!this.prismaAIRS || !this.prismaAIRS.isConfigured()) {
    return { approved: true };  // Graceful fallback
  }
  
  const result = await this.prismaAIRS.analyzePrompt(content, metadata);
  
  // Extract masked data if available
  let masked = content;
  if (result.maskedData?.prompt?.data) {
    masked = result.maskedData.prompt.data;
  }
  
  return {
    ...result,
    originalContent: content,
    maskedContent: masked,
    hasMasking: masked !== content,
    detectionDetails: result.maskedData?.prompt?.pattern_detections
  };
}
```

## Logging & Observability

When threats are detected, coordinator logs provide visibility:

```
ğŸ”’ [Coordinator] Security Checkpoint 1: Analyzing user input
ğŸ”’ Prisma AIRS analysis result: {
  action: 'allow',
  category: 'malicious',
  prompt_detected: {
    injection: false,
    dlp: true,
    malicious_code: false,
    url_cats: false
  }
}
ğŸ”’ [Coordinator] Sensitive data detected in user input - using masked query
ğŸ”’ Detections: [
  { pattern: 'SSN', count: 1 },
  { pattern: 'CREDIT_CARD', count: 1 }
]
ğŸ”’ [Coordinator] Using masked query for all downstream processing
   Original: "Name: John, SSN: 489-36-8350, CC: 4929-3813-3266-4295"
   Masked:   "Name: John, SSN: XXXXXXXXXXXXXXXX, CC: XXXXXXXXXXXXXXXX"
```

This provides:
- âœ… Audit trail of all detections
- âœ… Visibility into threat types
- âœ… Pattern detection details
- âœ… Before/after data comparison

## Best Practices

1. **Always use `phase3` in production**: Enables all security checkpoints
2. **Monitor security logs**: Check for patterns of attacks or data leakage
3. **Review DLP profiles**: Ensure sensitivity settings match your data classification
4. **Test threat scenarios**: Verify detection and masking work as expected
5. **Adjust detection thresholds**: Balance security vs. usability
6. **Enable contextual grounding**: For LLMs that synthesize from context
7. **Configure custom DLP profiles**: For organization-specific sensitive data patterns
8. **Monitor latency**: Set appropriate API response time thresholds

## Troubleshooting

### Threats not being detected
- Verify `phase: 'phase3'` is set
- Confirm Prisma AIRS API token is valid and not expired
- Check security profile has appropriate detections enabled
- Verify content matches enabled detection patterns

### False positives (too aggressive)
- Review security profile sensitivity settings
- Consider creating custom DLP profile with fewer patterns
- Check if detection threshold needs adjustment
- Review profile for overly broad URL categories

### Masking not working
- Verify DLP is set to "Block" action (required for masking)
- Check security profile has masking enabled
- Review logs for DLP detection (must detect to mask)
- Ensure custom DLP profile is properly configured

### Performance issues
- Check API response latency threshold
- Reduce number of detections if possible
- Consider DLP profile optimization
- Monitor Prisma AIRS service health

## Security Considerations

### What Prisma AIRS Protects
- âœ… Prompt injection attacks
- âœ… Sensitive data leakage (DLP)
- âœ… Malicious code execution
- âœ… Agent security threats
- âœ… Hallucinations (contextual grounding)

### What Prisma AIRS Does NOT Protect
- âŒ Network-level attacks (use firewall rules)
- âŒ Authentication/authorization (use IAM)
- âŒ Data at rest encryption (use storage encryption)
- âŒ API rate limiting (use API gateway)

### Defense in Depth
Use Prisma AIRS as part of comprehensive security:
- Application-level: Prisma AIRS scanning
- Network-level: Firewall policies
- Identity-level: Authentication & authorization
- Storage-level: Encryption at rest
- Audit-level: Comprehensive logging

## Related Documentation

- [Prisma AIRS Official Docs](https://docs.paloaltonetworks.com/ai-runtime-security)
- [Prisma AIRS API Reference](https://pan.dev/prisma-airs)
- [Create & Configure API Security Profile](https://docs.paloaltonetworks.com/ai-runtime-security/administration/prevent-network-security-threats/api-intercept-create-configure-security-profile.html)
- [MCP Architecture](docs/MCP-ARCHITECTURE.md)
- [Coordinator Design](docs/INTELLIGENT-MCP-COORDINATOR-PLAN.md)
